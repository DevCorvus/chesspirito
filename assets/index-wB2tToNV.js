var V=Object.defineProperty;var X=(i,e,t)=>e in i?V(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var a=(i,e,t)=>X(i,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(o){if(o.ep)return;o.ep=!0;const n=t(o);fetch(o.href,n)}})();const w=8,A=["a","b","c","d","e","f","g","h"],T=[8,7,6,5,4,3,2,1],z="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";var D=(i=>(i.WHITE_PAWN="P",i.WHITE_KNIGHT="N",i.WHITE_BISHOP="B",i.WHITE_ROOK="R",i.WHITE_QUEEN="Q",i.WHITE_KING="K",i.BLACK_PAWN="p",i.BLACK_KNIGHT="n",i.BLACK_BISHOP="b",i.BLACK_ROOK="r",i.BLACK_QUEEN="q",i.BLACK_KING="k",i))(D||{});function x(i){return i==="w"?"b":"w"}function F(i){return i<0||i>7}function k(i){return F(i.y)||F(i.x)}function m(i,e){return i.x===e.x&&i.y===e.y}function K(i,e){const t=i.board,s=[];for(const[o,n]of e){const r={y:i.position.y+o,x:i.position.x+n};for(;!k(r);){const l=t.getSquare(r);if((l===null||l.color!==i.color)&&s.push({from:i.position,to:{...r}}),l!==null)break;r.y+=o,r.x+=n}}return s}class b{constructor(e,t,s){a(this,"board");a(this,"type");a(this,"color");a(this,"position");a(this,"history");this.board=e,this.type=t==="w"?"P":"p",this.color=t,this.position=s,this.history=[]}generateMoves(){const e=this.color==="w"?-1:1,t={from:this.position,to:{y:this.position.y+e,x:this.position.x},onlyMove:!0},s=[t,{from:this.position,to:{y:this.position.y+e,x:this.position.x-1},onlyAttack:!0},{from:this.position,to:{y:this.position.y+e,x:this.position.x+1},onlyAttack:!0}];return this.history.length===0&&this.board.isSquareEmpty(t.to)&&s.push({from:this.position,to:{y:this.position.y+e*2,x:this.position.x},onlyMove:!0}),s.filter(o=>{if(k(o.to))return!1;const n=this.board.getSquare(o.to);if(n!==null&&o.onlyMove)return!1;const r=this.board.enPassantable;return n===null&&r&&m({y:r.y+(this.board.playingColor==="w"?1:-1),x:r.x},o.to)?(o.enPassant=!0,!0):n===null&&o.onlyAttack?!1:(n==null?void 0:n.color)!==this.color})}}class _{constructor(e,t,s){a(this,"board");a(this,"type");a(this,"color");a(this,"position");a(this,"history");this.board=e,this.type=t==="w"?"N":"n",this.color=t,this.position=s,this.history=[]}generateMoves(){const{x:e,y:t}=this.position;return[{y:t-1,x:e-2},{y:t-2,x:e-1},{y:t-2,x:e+1},{y:t-1,x:e+2},{y:t+1,x:e+2},{y:t+2,x:e+1},{y:t+2,x:e-1},{y:t+1,x:e-2}].map(o=>({from:this.position,to:o})).filter(o=>{var n;return!k(o.to)&&((n=this.board.getSquare(o.to))==null?void 0:n.color)!==this.color})}}class H{constructor(e,t,s){a(this,"board");a(this,"type");a(this,"color");a(this,"position");a(this,"history");this.board=e,this.type=t==="w"?"B":"b",this.color=t,this.position=s,this.history=[]}generateMoves(){return K(this,[[-1,-1],[-1,1],[1,1],[1,-1]])}}class Q{constructor(e,t,s){a(this,"board");a(this,"type");a(this,"color");a(this,"position");a(this,"history");this.board=e,this.type=t==="w"?"R":"r",this.color=t,this.position=s,this.history=[]}generateMoves(){return K(this,[[0,-1],[-1,0],[0,1],[1,0]])}}class G{constructor(e,t,s){a(this,"board");a(this,"type");a(this,"color");a(this,"position");a(this,"history");this.board=e,this.type=t==="w"?"Q":"q",this.color=t,this.position=s,this.history=[]}generateMoves(){return K(this,[[0,-1],[-1,0],[0,1],[1,0],[-1,-1],[-1,1],[1,1],[1,-1]])}}class C{constructor(e,t,s){a(this,"board");a(this,"type");a(this,"color");a(this,"position");a(this,"history");this.board=e,this.type=t==="w"?"K":"k",this.color=t,this.position=s,this.history=[]}generateMoves(){const{x:e,y:t}=this.position;return[{y:t-1,x:e-1},{y:t-1,x:e+0},{y:t-1,x:e+1},{y:t+0,x:e+1},{y:t+1,x:e+1},{y:t+1,x:e+0},{y:t+1,x:e-1},{y:t+0,x:e-1}].map(o=>({from:this.position,to:o})).filter(o=>{var n;return!k(o.to)&&((n=this.board.getSquare(o.to))==null?void 0:n.color)!==this.color})}}class U{static create(e,t,s){switch(t){case"P":return new b(e,"w",s);case"N":return new _(e,"w",s);case"B":return new H(e,"w",s);case"R":return new Q(e,"w",s);case"Q":return new G(e,"w",s);case"K":return new C(e,"w",s);case"p":return new b(e,"b",s);case"n":return new _(e,"b",s);case"b":return new H(e,"b",s);case"r":return new Q(e,"b",s);case"q":return new G(e,"b",s);case"k":return new C(e,"b",s)}}}class J{static create(e,t,s){let o;switch(t){case"N":{o=e.playingColor==="w"?"N":"n";break}case"B":{o=e.playingColor==="w"?"B":"b";break}case"R":{o=e.playingColor==="w"?"R":"r";break}case"Q":{o=e.playingColor==="w"?"Q":"q";break}}return U.create(e,o,s)}}class Y{constructor(e=z){a(this,"board");a(this,"history");a(this,"gameOver");a(this,"whiteKingPosition");a(this,"blackKingPosition");a(this,"playingColor");a(this,"check");a(this,"currLegalMoves");a(this,"currCastlingRights");a(this,"enPassantable");this.board=[],this.history=[],this.gameOver=null,this.whiteKingPosition=null,this.blackKingPosition=null,this.check=null,this.enPassantable=null;for(let l=0;l<w;l++){const u=Array(w).fill(null);this.board.push(u)}const t=e.split(" "),s=t[0].split("/"),o=t[1];this.playingColor=o;for(let l=0;l<w;l++){const u=s[l];for(let c=0;c<w;c++){const f=u[c];if(Object.values(D).includes(f)){const g={x:c,y:l},d=U.create(this,f,g);this.setSquare(g,d)}else{const g=Number(f);if(isNaN(g)||g<1||g>8)throw new Error("Invalid empty squares");c+=g}}}const n=this.generateLegalMoves(this.playingColor),r=this.inCheck(this.playingColor);this.check=r?this.playingColor:null,n.length===0&&(r?this.gameOver=this.playingColor==="w"?"1-0":"0-1":this.gameOver="0-0"),this.currLegalMoves=n,this.currCastlingRights=this.generateCastlingRights(this.playingColor)}getSquare(e){return this.board[e.y][e.x]}setSquare(e,t){if(this.board[e.y][e.x]=t,t!==null){const s=t;s.position=e,s instanceof C&&(s.color==="w"?this.whiteKingPosition=e:this.blackKingPosition=e)}}isSquareEmpty(e){return this.getSquare(e)===null}togglePlayingColor(){this.playingColor=x(this.playingColor)}getPositionFromMove(e){if(e.length!==2)throw new Error("Invalid move = "+e);const t=e[0],s=A.indexOf(t);if(s===-1)throw new Error("Invalid file = "+t);const o=e[1],n=T.indexOf(Number(o));if(n===-1)throw new Error("Invalid rank = "+o);return{x:s,y:n}}getMoveFromPosition(e){return A[e.x]+T[e.y]}generateLanFromMove({piece:e,from:t,to:s,capture:o,promotion:n,enPassant:r,check:l,mate:u}){let c=t;return e instanceof b||(c=e.type+c),o&&(c+="x"),c+=s,n!==null&&(c+="="+n),u?c+="#":l&&(c+="+"),r&&(c+=" e.p."),c}generateMoves(e){let t=[];for(let s=0;s<w;s++)for(let o=0;o<w;o++){const n=this.getSquare({y:s,x:o});if(n!==null&&n.color===e){const r=n.generateMoves();t=t.concat(r)}}return t}generateLegalMoves(e){const t=[],s=this.generateMoves(e),o=e==="w"?"K":"k",n=x(e);for(const r of s){const l=this.getSquare(r.from),u=this.getSquare(r.to);this.setSquare(r.to,l),this.setSquare(r.from,null),this.generateMoves(n).some(g=>{const d=this.getSquare(g.to);return d!==null&&d.type===o})||t.push(r),this.setSquare(r.to,u),this.setSquare(r.from,l)}return t}isSquareAttacked(e,t){return this.generateMoves(e).some(o=>o.onlyMove?!1:m(o.to,t))}getKingPosition(e){const t=e==="w"?this.whiteKingPosition:this.blackKingPosition;if(t===null)throw new Error("King not found");return t}inCheck(e){const t=this.getKingPosition(e),s=x(e);return this.isSquareAttacked(s,t)}handleNextTurn({mate:e,draw:t,nextLegalMoves:s}){(e||t)&&(this.currLegalMoves=[],this.currCastlingRights={queenside:null,kingside:null}),e?this.gameOver=this.playingColor==="w"?"1-0":"0-1":t?this.gameOver="0-0":(this.togglePlayingColor(),this.currLegalMoves=s,this.currCastlingRights=this.generateCastlingRights(this.playingColor))}generateCastlingRights(e){const t={queenside:null,kingside:null};if(this.inCheck(this.playingColor)||this.getSquare(this.getKingPosition(e)).history.length>0)return t;const o=(n,r)=>{const l=this.getSquare(n);if(l===null||l.history.length>0)return!1;for(const f of r)if(!this.isSquareEmpty(f))return!1;const u=r.slice(0,2),c=x(this.playingColor);for(const f of u)if(this.isSquareAttacked(c,f))return!1;return!0};if(this.playingColor==="w"){const n={y:7,x:0};o(n,[{y:7,x:3},{y:7,x:2},{y:7,x:1}])&&(t.queenside={target:{y:7,x:2},rook:{from:n,to:{y:7,x:3}}});const l={y:7,x:7};o(l,[{y:7,x:5},{y:7,x:6}])&&(t.kingside={target:{y:7,x:6},rook:{from:l,to:{y:7,x:5}}})}else{const n={y:0,x:0};o(n,[{y:0,x:3},{y:0,x:2},{y:0,x:1}])&&(t.queenside={target:{y:0,x:2},rook:{from:n,to:{y:0,x:3}}});const l={y:0,x:7};o(l,[{y:0,x:5},{y:0,x:6}])&&(t.kingside={target:{y:0,x:6},rook:{from:l,to:{y:0,x:5}}})}return t}handleCastlingMove(e,t,s){const o=t.x>s.x,n=this.currCastlingRights;if(n.queenside===null&&n.kingside===null||o&&n.queenside===null||!o&&n.kingside===null)throw new Error("Invalid castling");let r,l,u;if(o){const y=n.queenside.rook;r=this.getSquare(y.from),l=y.from,u=y.to}else{const y=n.kingside.rook;r=this.getSquare(y.from),l=y.from,u=y.to}this.setSquare(s,e),this.setSquare(t,null),this.setSquare(u,r),this.setSquare(l,null);const c=x(this.playingColor),f=this.generateLegalMoves(c),g=this.inCheck(c);this.check=g?c:null;let d=!1,q=!1;f.length===0&&(g?d=!0:q=!0),e.history.push(t),r.history.push(l);let v=o?"O-O-O":"O-O";d?v+="#":g&&(v+="+"),this.history.push({from:t,to:s,capture:null,promotion:null,castling:r,lan:v}),this.handleNextTurn({mate:d,draw:q,nextLegalMoves:f})}move(e,t,s="Q"){if(this.gameOver!==null)throw new Error("Invalid move = GameOver");const o=typeof e=="string"?this.getPositionFromMove(e):e,n=typeof t=="string"?this.getPositionFromMove(t):t,r=typeof e=="object"?this.getMoveFromPosition(e):e,l=typeof t=="object"?this.getMoveFromPosition(t):t;if(k(o)||k(n))throw new Error("Invalid move = out of bounds");const u=this.getSquare(o),c=this.getSquare(n);if(u===null)throw new Error("Invalid move = no piece");if(u.color!==this.playingColor)throw new Error("Invalid move = not playing color");if((c==null?void 0:c.color)===this.playingColor)throw new Error("Invalid move = cannot move to friendly piece");if(c instanceof C)throw new Error("Invalid move = King cannot be captured");if(u instanceof C&&o.y===n.y&&Math.abs(n.x-o.x)===2)return this.handleCastlingMove(u,o,n);const f=c!==null;let g=!1;if(!this.currLegalMoves.some(S=>m(S.from,o)&&m(S.to,n)?(S.enPassant&&(g=!0),!0):!1))throw new Error("Invalid move = "+r+"-"+l);let q=c;this.setSquare(n,u),this.setSquare(o,null),this.enPassantable&&g&&(q=this.getSquare(this.enPassantable),this.setSquare(this.enPassantable,null));let v=!1;if(u instanceof b){!f&&Math.abs(n.y-o.y)===2?this.enPassantable=n:this.enPassantable=null;const S=this.playingColor==="w"?0:7;if(n.y===S){const B=J.create(this,s,n);this.setSquare(n,B),v=!0}}const y=x(this.playingColor),I=this.generateLegalMoves(y),L=this.inCheck(y);this.check=L?y:null;let R=!1,N=!1;I.length===0&&(L?R=!0:N=!0),u.history.push(o),this.history.push({from:o,to:n,capture:q,promotion:v?u:null,castling:null,lan:this.generateLanFromMove({piece:u,from:r,to:l,capture:q!==null,promotion:v?s:null,enPassant:g,check:L,mate:R})}),this.handleNextTurn({mate:R,draw:N,nextLegalMoves:I})}undo(){const e=this.history.pop();if(!e)throw new Error("Invalid undo = clean history");const t=this.getSquare(e.to);if(t===null)throw new Error("Invalid undo = unexpected nullish piece");if(t.history.pop(),e.promotion!==null?(this.setSquare(e.from,e.promotion),e.promotion.history.pop()):this.setSquare(e.from,t),e.capture!==null?m(e.to,e.capture.position)?this.setSquare(e.to,e.capture):(this.setSquare(e.capture.position,e.capture),this.setSquare(e.to,null),this.enPassantable=e.capture.position):this.setSquare(e.to,null),e.castling!==null){const s=e.castling.history.pop();if(!s)throw new Error("Invalid undo = unexpected castling error");this.setSquare(e.castling.position,null),this.setSquare(s,e.castling)}this.gameOver===null&&this.togglePlayingColor(),this.inCheck(this.playingColor)?this.check=this.playingColor:this.check=null,this.gameOver=null,this.currLegalMoves=this.generateLegalMoves(this.playingColor),this.currCastlingRights=this.generateCastlingRights(this.playingColor)}getLegalMoves(e){return this.currLegalMoves.filter(t=>m(t.from,e))}}const h=new Y,Z={P:"/pieces/pawn.png",N:"/pieces/knight.png",B:"/pieces/bishop.png",R:"/pieces/rook.png",Q:"/pieces/queen.png",K:"/pieces/king.png"},E=document.getElementById("chessboard"),W=document.getElementById("scoreboard"),ee=document.getElementById("undo"),te=document.getElementById("gameover-status");ee.addEventListener("click",()=>{try{h.undo(),O()}catch(i){console.error(i),i instanceof Error&&alert(i.message)}});let p=null;function P(i){return E.querySelector(`[data-y="${i.y}"][data-x="${i.x}"]`)}function M(i){return"inset 0 0 13px 0 "+i}function oe(){te.textContent=h.gameOver!==null?h.gameOver:"N/A"}function se(i){const e=h.getLegalMoves(i);for(const t of e){const s=P(t.to);h.getSquare(t.to)!==null&&!t.onlyMove||t.onlyAttack?s.style.boxShadow=M("red"):s.style.boxShadow=M("lime")}}function ne(){const{queenside:i,kingside:e}=h.currCastlingRights,t=M("deepskyblue");if(i!==null){const s=P(i.target);s.style.boxShadow=t}if(e!==null){const s=P(e.target);s.style.boxShadow=t}}function j(){if(h.check!==null){const i=h.getKingPosition(h.check),e=P(i);e.style.boxShadow=M("cyan")}}function $(){for(const i of E.children)i.style.boxShadow=""}function ie(){let i=!1;h.board.forEach((e,t)=>{e.forEach((s,o)=>{const n=document.createElement("div");n.style.background=i?"#5a5a6a":"#b1b1c1",n.dataset.y=String(t),n.dataset.x=String(o),n.addEventListener("dragstart",()=>{if(h.gameOver!==null)return;p={y:t,x:o},se(p);const r=h.getKingPosition(h.playingColor);m(p,r)&&ne()}),n.addEventListener("dragend",()=>{p=null,$(),j()}),n.addEventListener("dragover",r=>{r.preventDefault()}),n.addEventListener("drop",r=>{const l=r.currentTarget,u={y:Number(l.dataset.y),x:Number(l.dataset.x)};if(p&&!m(p,u))try{h.move(p,u),O(),h.gameOver!==null&&alert(h.gameOver)}catch(c){console.error(c),c instanceof Error&&alert(c.message)}finally{p=null}}),E.append(n),i=!i}),i=!i})}function re(){for(const i of E.children){i.innerHTML="";const e={y:Number(i.dataset.y),x:Number(i.dataset.x)},t=h.getSquare(e);if(t!==null){const s=document.createElement("img"),o=t.type.toUpperCase();s.src=Z[o],t.color==="b"&&(s.style.filter="invert(100%)"),t.type==="p"&&(s.style.transform="rotateX(180deg)"),i.appendChild(s)}}}function ae(){W.innerHTML="";for(const i of h.history){const e=document.createElement("span");e.textContent=i.lan,W.appendChild(e)}}function O(){$(),re(),j(),ae(),oe()}ie();O();
